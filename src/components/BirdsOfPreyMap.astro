---
// BirdsOfPreyMap — Displays birds of prey sightings near Boulder, CO
// Uses GBIF Occurrence API and Leaflet.js
---

<div id="birds-map-container">
  <div class="birds-header">
    <h2>Birds of Prey Near Boulder, CO</h2>
    <p class="birds-subtitle">Recent sightings within 100 miles from GBIF</p>
  </div>

  <div class="birds-controls">
    <select id="birds-taxon">
      <option value="all">All Birds of Prey</option>
      <option value="2877">Hawks, Eagles & Kites (Accipitriformes)</option>
      <option value="7191">Falcons (Falconiformes)</option>
      <option value="1458">Owls (Strigiformes)</option>
    </select>
    <button id="birds-refresh">Refresh Data</button>
  </div>

  <div id="birds-loading" class="birds-message">Loading bird sightings...</div>
  <div id="birds-error" class="birds-message birds-error" style="display:none"></div>

  <div id="birds-map"></div>

  <div id="birds-species-section" class="birds-species-section">
    <h3>Species Found <span id="birds-species-count-label"></span></h3>
    <p class="birds-section-subtitle">Click a species for photos and details</p>
    <div id="birds-species-grid" class="birds-species-grid"></div>
  </div>

  <div class="birds-stats">
    <span id="birds-count">0 sightings</span>
    <span id="birds-species">0 species</span>
  </div>

  <p class="birds-attribution">
    Data from <a href="https://www.gbif.org" target="_blank" rel="noopener">GBIF.org</a> |
    Photos from <a href="https://www.inaturalist.org" target="_blank" rel="noopener">iNaturalist</a> |
    Descriptions from <a href="https://www.wikipedia.org" target="_blank" rel="noopener">Wikipedia</a>
  </p>
</div>

<!-- Species Detail Modal -->
<div id="species-modal" class="species-modal">
  <div class="species-modal-backdrop"></div>
  <div class="species-modal-content">
    <button id="species-modal-close" class="species-modal-close">&times;</button>

    <div id="species-modal-loading" class="species-modal-loading">
      Loading species information...
    </div>

    <div id="species-modal-body" class="species-modal-body" style="display:none">
      <div class="species-modal-gallery">
        <img id="species-modal-image" src="" alt="" />
        <div id="species-modal-thumbnails" class="species-modal-thumbnails"></div>
      </div>

      <div class="species-modal-info">
        <h2 id="species-modal-name"></h2>
        <p id="species-modal-common" class="species-common-name"></p>

        <div class="species-meta">
          <span id="species-modal-order" class="species-tag"></span>
          <span id="species-modal-family" class="species-tag"></span>
          <span id="species-modal-sightings" class="species-tag"></span>
        </div>

        <div id="species-modal-description" class="species-description"></div>

        <div class="species-links">
          <a id="species-link-wikipedia" href="#" target="_blank" rel="noopener">Wikipedia</a>
          <a id="species-link-inaturalist" href="#" target="_blank" rel="noopener">iNaturalist</a>
          <a id="species-link-gbif" href="#" target="_blank" rel="noopener">GBIF</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
  // Load Leaflet dynamically
  const leafletScript = document.createElement('script');
  leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
  leafletScript.onload = initMap;
  document.head.appendChild(leafletScript);

  // Boulder, CO coordinates
  const BOULDER_LAT = 40.015;
  const BOULDER_LNG = -105.2705;
  const RADIUS_MILES = 100;
  const RADIUS_KM = RADIUS_MILES * 1.60934;

  // GBIF taxon keys for birds of prey
  const TAXON_KEYS = {
    all: [2877, 7191, 1458], // Accipitriformes, Falconiformes, Strigiformes
    2877: [2877], // Hawks, Eagles
    7191: [7191], // Falcons
    1458: [1458], // Owls
  };

  // Valid raptor orders - strict filter to exclude any non-raptor species
  const VALID_RAPTOR_ORDERS = ['Accipitriformes', 'Falconiformes', 'Strigiformes'];

  let map: any;
  let markers: any[] = [];
  let markerCluster: any;

  // Species data cache
  interface SpeciesInfo {
    scientificName: string;
    vernacularName: string;
    order: string;
    family: string;
    count: number;
    gbifKey: number;
  }
  let speciesData: Map<string, SpeciesInfo> = new Map();

  async function initMap() {
    const L = (window as any).L;

    // Initialize map centered on Boulder
    map = L.map('birds-map').setView([BOULDER_LAT, BOULDER_LNG], 8);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 18,
    }).addTo(map);

    // Add Boulder marker
    L.circleMarker([BOULDER_LAT, BOULDER_LNG], {
      radius: 8,
      fillColor: '#8b5cf6',
      color: '#6d28d9',
      weight: 2,
      opacity: 1,
      fillOpacity: 0.8,
    })
      .addTo(map)
      .bindPopup('<strong>Boulder, CO</strong><br>Search center');

    // Add 100-mile radius circle
    L.circle([BOULDER_LAT, BOULDER_LNG], {
      radius: RADIUS_KM * 1000,
      color: '#8b5cf6',
      fillColor: '#8b5cf6',
      fillOpacity: 0.05,
      weight: 1,
      dashArray: '5, 5',
    }).addTo(map);

    // Load initial data
    await loadBirdData('all');

    // Event listeners
    document.getElementById('birds-taxon')!.addEventListener('change', (e) => {
      const value = (e.target as HTMLSelectElement).value;
      loadBirdData(value);
    });

    document.getElementById('birds-refresh')!.addEventListener('click', () => {
      const value = (document.getElementById('birds-taxon') as HTMLSelectElement).value;
      loadBirdData(value);
    });
  }

  async function loadBirdData(taxonFilter: string) {
    const L = (window as any).L;
    const elLoading = document.getElementById('birds-loading')!;
    const elError = document.getElementById('birds-error')!;
    const elCount = document.getElementById('birds-count')!;
    const elSpecies = document.getElementById('birds-species')!;

    // Clear existing markers
    markers.forEach((m) => map.removeLayer(m));
    markers = [];

    elLoading.style.display = 'block';
    elError.style.display = 'none';

    try {
      const taxonKeys = TAXON_KEYS[taxonFilter as keyof typeof TAXON_KEYS];
      const allOccurrences: any[] = [];

      // Fetch data for each taxon key with pagination (GBIF caps at 300 per request)
      const GBIF_LIMIT = 300;
      const MAX_PAGES = 4; // Up to 1200 results per taxon

      for (const taxonKey of taxonKeys) {
        let offset = 0;
        let page = 0;
        let hasMore = true;

        while (hasMore && page < MAX_PAGES) {
          const params = new URLSearchParams({
            taxonKey: String(taxonKey),
            decimalLatitude: `${BOULDER_LAT - 1.5},${BOULDER_LAT + 1.5}`,
            decimalLongitude: `${BOULDER_LNG - 2},${BOULDER_LNG + 2}`,
            hasCoordinate: 'true',
            hasGeospatialIssue: 'false',
            limit: String(GBIF_LIMIT),
            offset: String(offset),
            year: `${new Date().getFullYear() - 5},${new Date().getFullYear()}`,
          });

          const response = await fetch(
            `https://api.gbif.org/v1/occurrence/search?${params}`
          );

          if (!response.ok) throw new Error(`GBIF API error: ${response.status}`);

          const data = await response.json();
          allOccurrences.push(...data.results);

          // Check if there are more results
          hasMore = data.endOfRecords === false && data.results.length === GBIF_LIMIT;
          offset += GBIF_LIMIT;
          page++;
        }
      }

      elLoading.style.display = 'none';

      if (allOccurrences.length === 0) {
        elCount.textContent = '0 sightings';
        elSpecies.textContent = '0 species';
        return;
      }

      // Track unique species with metadata
      speciesData.clear();

      // Filter to only valid raptor orders and create markers
      const validOccurrences = allOccurrences.filter(occ => {
        // Must have coordinates
        if (!occ.decimalLatitude || !occ.decimalLongitude) return false;
        // Must have a valid raptor order - strict validation
        if (!occ.order || !VALID_RAPTOR_ORDERS.includes(occ.order)) return false;
        // Must have a species name
        if (!occ.species && !occ.genericName) return false;
        return true;
      });

      // Create markers and build species data
      for (const occ of validOccurrences) {
        const speciesName = occ.species || occ.genericName;

        // Update species data
        // Note: We don't use occ.vernacularName as it may be non-English
        // Common names are fetched separately from GBIF/iNaturalist APIs
        if (speciesData.has(speciesName)) {
          speciesData.get(speciesName)!.count++;
        } else {
          speciesData.set(speciesName, {
            scientificName: speciesName,
            vernacularName: '',
            order: occ.order,
            family: occ.family || 'Unknown',
            count: 1,
            gbifKey: occ.speciesKey || occ.taxonKey || 0,
          });
        }

        const marker = L.circleMarker([occ.decimalLatitude, occ.decimalLongitude], {
          radius: 6,
          fillColor: getColorForOrder(occ.order),
          color: '#fff',
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8,
        });

        const date = occ.eventDate
          ? new Date(occ.eventDate).toLocaleDateString()
          : 'Date unknown';

        marker.bindPopup(`
          <strong>${speciesName}</strong><br>
          Order: ${occ.order}<br>
          Date: ${date}<br>
          ${occ.stateProvince ? `Location: ${occ.stateProvince}<br>` : ''}
          <button class="popup-species-btn" onclick="window.openSpeciesModal('${speciesName.replace(/'/g, "\\'")}')">View Species Details</button>
        `);

        marker.addTo(map);
        markers.push(marker);
      }

      // Fetch common names for species missing vernacularName
      await fetchMissingCommonNames();

      // Build species list panel
      renderSpeciesList();

      elCount.textContent = `${validOccurrences.length} sightings`;
      elSpecies.textContent = `${speciesData.size} species`;
    } catch (err) {
      elLoading.style.display = 'none';
      elError.style.display = 'block';
      elError.textContent = 'Failed to load bird data. Please try again.';
      console.error(err);
    }
  }

  function getColorForOrder(order: string): string {
    switch (order) {
      case 'Accipitriformes':
        return '#ef4444'; // Red - Hawks, Eagles
      case 'Falconiformes':
        return '#f97316'; // Orange - Falcons
      case 'Strigiformes':
        return '#3b82f6'; // Blue - Owls
      default:
        return '#6b7280'; // Gray
    }
  }

  // Fetch common names for species missing vernacularName
  // Uses multiple sources: Wikipedia (best for English), iNaturalist, then GBIF
  async function fetchMissingCommonNames() {
    const speciesNeedingNames = Array.from(speciesData.entries())
      .filter(([_, info]) => !info.vernacularName)
      .slice(0, 50);

    const fetchPromises = speciesNeedingNames.map(async ([name, info]) => {
      try {
        // 1. Try Wikipedia first - article titles are often common English names
        const wikiTitle = name.replace(/ /g, '_');
        const wikiResponse = await fetch(
          `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(wikiTitle)}`
        );
        if (wikiResponse.ok) {
          const wikiData = await wikiResponse.json();
          // Wikipedia often redirects scientific names to common name articles
          // Check if title differs from scientific name and looks like English
          const pageTitle = wikiData.title;
          if (pageTitle &&
              pageTitle.toLowerCase() !== name.toLowerCase() &&
              /^[A-Za-z\s\-']+$/.test(pageTitle)) {
            info.vernacularName = pageTitle;
            return;
          }
        }

        // 2. Try iNaturalist - use both english_common_name and preferred_common_name
        const inatResponse = await fetch(
          `https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(name)}&rank=species&per_page=1&locale=en`
        );
        if (inatResponse.ok) {
          const inatData = await inatResponse.json();
          const taxon = inatData.results?.[0];
          const commonName = taxon?.english_common_name || taxon?.preferred_common_name;
          if (commonName && /^[A-Za-z\s\-']+$/.test(commonName)) {
            info.vernacularName = commonName;
            return;
          }
        }

        // 3. Last resort: GBIF with strict ASCII check
        if (info.gbifKey) {
          const response = await fetch(
            `https://api.gbif.org/v1/species/${info.gbifKey}/vernacularNames?limit=20`
          );
          if (response.ok) {
            const data = await response.json();
            const englishName = data.results?.find(
              (n: any) => (n.language === 'eng' || n.language === 'en') &&
                          /^[A-Za-z\s\-']+$/.test(n.vernacularName)
            );
            if (englishName?.vernacularName) {
              info.vernacularName = englishName.vernacularName;
            }
          }
        }
      } catch {
        // Ignore errors for individual species lookups
      }
    });

    await Promise.all(fetchPromises);
  }

  /* ── Species Grid ── */
  function renderSpeciesList() {
    const gridEl = document.getElementById('birds-species-grid')!;
    const countLabel = document.getElementById('birds-species-count-label')!;
    gridEl.innerHTML = '';

    // Filter out unknown and sort by count descending
    const filtered = Array.from(speciesData.entries())
      .filter(([name, info]) => name !== 'Unknown' && info.order !== 'Unknown')
      .sort((a, b) => b[1].count - a[1].count);

    countLabel.textContent = `(${filtered.length})`;

    for (const [name, info] of filtered) {
      const displayName = info.vernacularName || name;
      const card = document.createElement('div');
      card.className = 'species-card';
      card.innerHTML = `
        <div class="species-card-color" style="background: ${getColorForOrder(info.order)}"></div>
        <div class="species-card-content">
          <span class="species-card-common">${displayName}</span>
          <span class="species-card-scientific">${name}</span>
        </div>
        <span class="species-card-count">${info.count}</span>
      `;
      card.addEventListener('click', () => openSpeciesModal(name));
      gridEl.appendChild(card);
    }
  }

  /* ── Species Modal ── */
  async function openSpeciesModal(speciesName: string) {
    const modal = document.getElementById('species-modal')!;
    const loading = document.getElementById('species-modal-loading')!;
    const body = document.getElementById('species-modal-body')!;

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    loading.style.display = 'block';
    body.style.display = 'none';

    const info = speciesData.get(speciesName);
    if (!info) {
      loading.textContent = 'Species not found';
      return;
    }

    try {
      // Fetch data from both APIs in parallel
      const [wikiData, inatData] = await Promise.all([
        fetchWikipediaData(speciesName),
        fetchINaturalistData(speciesName),
      ]);

      // Populate modal
      document.getElementById('species-modal-name')!.textContent = speciesName;
      document.getElementById('species-modal-common')!.textContent = info.vernacularName || wikiData.commonName || inatData.commonName || '';
      document.getElementById('species-modal-order')!.textContent = info.order;
      document.getElementById('species-modal-family')!.textContent = info.family;
      document.getElementById('species-modal-sightings')!.textContent = `${info.count} sightings`;

      // Description from Wikipedia
      const descEl = document.getElementById('species-modal-description')!;
      descEl.innerHTML = wikiData.extract || '<em>No description available.</em>';

      // Images - prefer iNaturalist, fallback to Wikipedia
      const mainImage = document.getElementById('species-modal-image') as HTMLImageElement;
      const thumbnails = document.getElementById('species-modal-thumbnails')!;
      thumbnails.innerHTML = '';

      const allPhotos = [...inatData.photos];
      if (wikiData.image && !allPhotos.includes(wikiData.image)) {
        allPhotos.unshift(wikiData.image);
      }

      if (allPhotos.length > 0) {
        mainImage.src = allPhotos[0];
        mainImage.alt = speciesName;
        mainImage.style.display = 'block';

        // Add thumbnails if multiple photos
        if (allPhotos.length > 1) {
          allPhotos.slice(0, 6).forEach((url, idx) => {
            const thumb = document.createElement('img');
            thumb.src = url;
            thumb.alt = `${speciesName} photo ${idx + 1}`;
            thumb.className = idx === 0 ? 'active' : '';
            thumb.addEventListener('click', () => {
              mainImage.src = url;
              thumbnails.querySelectorAll('img').forEach(t => t.classList.remove('active'));
              thumb.classList.add('active');
            });
            thumbnails.appendChild(thumb);
          });
        }
      } else {
        mainImage.style.display = 'none';
      }

      // Links
      const wikiTitle = speciesName.replace(/ /g, '_');
      (document.getElementById('species-link-wikipedia') as HTMLAnchorElement).href =
        `https://en.wikipedia.org/wiki/${wikiTitle}`;
      (document.getElementById('species-link-inaturalist') as HTMLAnchorElement).href =
        `https://www.inaturalist.org/taxa/search?q=${encodeURIComponent(speciesName)}`;
      (document.getElementById('species-link-gbif') as HTMLAnchorElement).href =
        `https://www.gbif.org/species/${info.gbifKey}`;

      loading.style.display = 'none';
      body.style.display = 'flex';
    } catch (err) {
      console.error('Error loading species data:', err);
      loading.textContent = 'Failed to load species information.';
    }
  }

  async function fetchWikipediaData(speciesName: string): Promise<{ extract: string; image: string; commonName: string }> {
    try {
      const title = speciesName.replace(/ /g, '_');
      const response = await fetch(
        `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`
      );

      if (!response.ok) {
        return { extract: '', image: '', commonName: '' };
      }

      const data = await response.json();
      // Check if page title differs from scientific name and looks English
      const pageTitle = data.title || '';
      const isCommonName = pageTitle &&
        pageTitle.toLowerCase() !== speciesName.toLowerCase() &&
        /^[A-Za-z\s\-']+$/.test(pageTitle);

      return {
        extract: data.extract || '',
        image: data.thumbnail?.source || data.originalimage?.source || '',
        commonName: isCommonName ? pageTitle : '',
      };
    } catch {
      return { extract: '', image: '', commonName: '' };
    }
  }

  async function fetchINaturalistData(speciesName: string): Promise<{ photos: string[]; commonName: string }> {
    try {
      const response = await fetch(
        `https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(speciesName)}&rank=species&per_page=1&locale=en`
      );

      if (!response.ok) {
        return { photos: [], commonName: '' };
      }

      const data = await response.json();
      if (data.results && data.results.length > 0) {
        const taxon = data.results[0];
        const photos = taxon.taxon_photos?.map((p: any) => p.photo.medium_url) || [];
        // Use english_common_name or preferred_common_name if it looks English
        const commonName = taxon.english_common_name || taxon.preferred_common_name || '';
        const isEnglish = /^[A-Za-z\s\-']+$/.test(commonName);
        return {
          photos: photos.slice(0, 6),
          commonName: isEnglish ? commonName : '',
        };
      }

      return { photos: [], commonName: '' };
    } catch {
      return { photos: [], commonName: '' };
    }
  }

  function closeSpeciesModal() {
    const modal = document.getElementById('species-modal')!;
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }

  // Expose openSpeciesModal globally for popup buttons
  (window as any).openSpeciesModal = openSpeciesModal;

  // Modal event listeners
  document.getElementById('species-modal-close')!.addEventListener('click', closeSpeciesModal);
  document.querySelector('.species-modal-backdrop')!.addEventListener('click', closeSpeciesModal);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeSpeciesModal();
  });
</script>

<style is:global>
  #birds-map-container {
    margin: 2rem 0;
  }

  .birds-header {
    margin-bottom: 1rem;
  }

  .birds-header h2 {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }

  .birds-subtitle {
    color: var(--color-muted);
    font-size: 0.9375rem;
  }

  .birds-controls {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  #birds-taxon {
    padding: 0.5rem 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-family: var(--font-sans);
    background: white;
    cursor: pointer;
    min-width: 200px;
  }

  #birds-taxon:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  #birds-refresh {
    padding: 0.5rem 1rem;
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  #birds-refresh:hover {
    background: #7c3aed;
  }

  .birds-message {
    padding: 2rem;
    text-align: center;
    background: #f9fafb;
    border-radius: 8px;
    color: var(--color-muted);
  }

  .birds-error {
    background: #fef2f2;
    color: #b91c1c;
  }

  #birds-map {
    height: 500px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
  }

  /* Species Section (below map) */
  .birds-species-section {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
  }

  .birds-species-section h3 {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
  }

  .birds-species-section h3 span {
    font-weight: 400;
    color: var(--color-muted);
    font-size: 1rem;
  }

  .birds-section-subtitle {
    font-size: 0.875rem;
    color: var(--color-muted);
    margin-bottom: 1rem;
  }

  .birds-species-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 0.75rem;
  }

  .species-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .species-card:hover {
    background: white;
    border-color: var(--color-accent);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.12);
    transform: translateY(-1px);
  }

  .species-card-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .species-card-content {
    flex: 1;
    min-width: 0;
  }

  .species-card-common {
    display: block;
    font-weight: 600;
    font-size: 0.9375rem;
    color: var(--color-text);
    margin-bottom: 0.125rem;
  }

  .species-card-scientific {
    display: block;
    font-size: 0.8125rem;
    color: var(--color-muted);
    font-style: italic;
  }

  .species-card-count {
    font-size: 0.8125rem;
    font-weight: 600;
    color: white;
    background: var(--color-accent);
    padding: 0.25rem 0.625rem;
    border-radius: 12px;
    flex-shrink: 0;
  }

  /* Popup button */
  .popup-species-btn {
    display: block;
    width: 100%;
    margin-top: 0.5rem;
    padding: 0.375rem 0.5rem;
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.8125rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .popup-species-btn:hover {
    background: #7c3aed;
  }

  .birds-stats {
    display: flex;
    gap: 1.5rem;
    margin-top: 1rem;
    font-size: 0.9375rem;
  }

  .birds-stats span {
    padding: 0.5rem 1rem;
    background: #f3f4f6;
    border-radius: 6px;
    font-weight: 500;
  }

  .birds-attribution {
    margin-top: 1rem;
    font-size: 0.8125rem;
    color: var(--color-muted);
  }

  .birds-attribution a {
    color: var(--color-accent);
    text-decoration: none;
  }

  .birds-attribution a:hover {
    text-decoration: underline;
  }

  /* Leaflet popup styling */
  .leaflet-popup-content-wrapper {
    border-radius: 8px;
  }

  .leaflet-popup-content {
    font-family: var(--font-sans);
    font-size: 0.875rem;
    line-height: 1.5;
  }

  .leaflet-popup-content a {
    color: var(--color-accent);
  }

  /* Legend */
  .birds-legend {
    display: flex;
    gap: 1rem;
    margin-top: 0.75rem;
    flex-wrap: wrap;
  }

  .birds-legend-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8125rem;
    color: var(--color-muted);
  }

  .birds-legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }

  /* Species Modal */
  .species-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .species-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
  }

  .species-modal-content {
    position: relative;
    background: white;
    border-radius: 16px;
    width: 100%;
    max-width: 900px;
    max-height: 85vh;
    overflow: hidden;
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.25s ease-out;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .species-modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 10;
    background: white;
    border: none;
    font-size: 1.75rem;
    cursor: pointer;
    color: var(--color-muted);
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .species-modal-close:hover {
    background: #f3f4f6;
    color: var(--color-text);
  }

  .species-modal-loading {
    padding: 4rem 2rem;
    text-align: center;
    color: var(--color-muted);
  }

  .species-modal-body {
    display: flex;
    max-height: 85vh;
    overflow: hidden;
  }

  .species-modal-gallery {
    width: 45%;
    background: #1a1a1a;
    display: flex;
    flex-direction: column;
  }

  #species-modal-image {
    flex: 1;
    width: 100%;
    object-fit: cover;
    min-height: 300px;
  }

  .species-modal-thumbnails {
    display: flex;
    gap: 4px;
    padding: 4px;
    background: #0a0a0a;
    overflow-x: auto;
  }

  .species-modal-thumbnails img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s;
  }

  .species-modal-thumbnails img:hover,
  .species-modal-thumbnails img.active {
    opacity: 1;
  }

  .species-modal-info {
    flex: 1;
    padding: 2rem;
    overflow-y: auto;
  }

  #species-modal-name {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    font-style: italic;
  }

  .species-common-name {
    font-size: 1.125rem;
    color: var(--color-muted);
    margin-bottom: 1rem;
  }

  .species-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .species-tag {
    padding: 0.375rem 0.75rem;
    background: #f3f4f6;
    border-radius: 6px;
    font-size: 0.8125rem;
    color: #4b5563;
  }

  .species-description {
    font-size: 0.9375rem;
    line-height: 1.7;
    color: var(--color-text);
    margin-bottom: 1.5rem;
  }

  .species-links {
    display: flex;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
  }

  .species-links a {
    padding: 0.5rem 1rem;
    background: #f3f4f6;
    border-radius: 6px;
    font-size: 0.875rem;
    color: var(--color-text);
    text-decoration: none;
    transition: all 0.2s;
  }

  .species-links a:hover {
    background: var(--color-accent);
    color: white;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .species-modal-body {
      flex-direction: column;
    }

    .species-modal-gallery {
      width: 100%;
      max-height: 250px;
    }

    #species-modal-image {
      min-height: 200px;
    }

    .birds-species-grid {
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    }
  }

  @media (max-width: 640px) {
    #birds-map {
      height: 350px;
    }

    .birds-controls {
      flex-direction: column;
    }

    #birds-taxon {
      width: 100%;
    }

    .species-modal-content {
      max-height: 95vh;
    }

    .species-modal-info {
      padding: 1.25rem;
    }

    #species-modal-name {
      font-size: 1.375rem;
    }
  }
</style>
